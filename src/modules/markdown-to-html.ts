import {
  base64,
  getCommandLineArgs,
  PipeFunctions,
  PipeServerAPIv03,
  processPipeMessages,
} from "../dependencies.ts";

/*
  TODO:
  - Auto reload by polling?
  - Add generated by and pgp+checksum (separate pipeline?)
  - VIM keybindings for the pages themselves (another plugin maybe?)
  - Remove multiple svgs with the same data and reference it ( not easy )
  - Submit the '''js [1|2|3-4] bug to the showdownjs guys
  - Copy to clipboard in every <pre> tag: https://designly.biz/blog/post/react-markdown-how-to-create-a-copy-code-button
*/

const args = getCommandLineArgs({
  highlightSupport: true,
  graphvizSupport: true,
  autotocSupport: true,
  embeddedYoutubeLinks: true,
  addEditInVimLink: true,
  changeHtmlLinksToVim: true,
});

const markdownToHtmlHandler = (
  message: PipeServerAPIv03,
  pipe: PipeFunctions,
) => {
  // we only care about messages that already contain type=markdown
  if (message.reply.type !== "markdown" || message.reply.body === undefined) {
    return message;
  }

  pipe.debug("Converting markdown to html5");

  message.reply.body = htmlTemplate(
    message.reply.body!,
    message.request.fullUrl,
  );
  message.reply.type = "html";

  return message;
};

const highlightSupport = `
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/vim.min.js"></script>
  <style>
  .markdown-body pre code {
    background-color: #272822 !important;
  }
  </style>
  <script>window.addEventListener('load', hljs.highlightAll);</script>
`;

const graphvizSupport = `
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
  <script>
  window.addEventListener('load', () => {
      var viz = new Viz();

      let dot_documents = document.querySelectorAll('code.language-dot');
  
      dot_documents.forEach(node => {
          let code = node.textContent;
          console.log(code);
  
          viz.renderSVGElement(code)
          .then(function(element) {
              node.parentNode.replaceChild(element, node);
              // take it out of the <pre> tag
              let pre = element.parentNode;
              pre.parentNode.replaceChild(element, pre);
          })
          .catch(error => {
              // Create a new Viz instance (@see Caveats page for more info)
              viz = new Viz();
  
              // Possibly display the error
              console.error(error);
          });
      });
  });
  </script>
`;

const autotocSupport = `
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.20.1/tocbot.min.js"></script>
  <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.20.1/tocbot.css">-->
  <script>
  window.addEventListener('load', () => {
    tocbot.init({
      // Where to render the table of contents.
      tocSelector: '.toc',
      // Where to grab the headings to build the table of contents.
      contentSelector: '#markdown-body'
    });
  });
  </script>
`;

const showdownjsSupport = `
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
  <style>
			body {
				box-sizing: border-box;
				min-width: 200px;
				max-width: 980px;
				margin: 0 auto;
				padding: 45px;
			}

			@media (prefers-color-scheme: dark) {
				body {
					background-color: #0d1117;
				}
			}
	</style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

  <script>

  function decodeUnicode(str) {
    // Going backwards: from bytestream, to percent-encoding, to original string.
    return decodeURIComponent(atob(str).split('').map(function (c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
  }

  window.addEventListener('load', () => {

      // extension
      showdown.extension('header-anchors', function() {

        var ancTpl = '$1<a id="user-content-$3" class="anchor" href="#$3" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>$4';

        return [{
          type: 'html',
          regex: /(<h([1-3]) id="([^"]+?)">)(.*<\\/h\\2>)/g,
          replace: ancTpl
        }];
      });

      // options
      showdown.setFlavor('github');
      showdown.setOption('simplifiedAutoLink', true);
      showdown.setOption('strikethrough', true);
      showdown.setOption('tables', true);
      showdown.setOption('tasklists', true);
      showdown.setOption('requireSpaceBeforeHeadingText', true);
      showdown.setOption('emoji', true);
      showdown.setOption('metadata', true);

      var converter = new showdown.Converter({
        extensions: ['header-anchors']
      }),
      text = document.getElementById("markdown-source").textContent,
      decodedText = decodeUnicode(text);

      // showdownjs doesn't like code blocks with extra stuff after the language name
      // remove it if it looks like "\`\`\`something [1|2|3-4]"
      //
      decodedText = decodedText.replace(/(\`\`\`[\\S]*)[\\s]*(\\[.*\\])/gm, "$1");

      html = converter.makeHtml(decodedText);

      var body = document.getElementById("markdown-body");
      body.innerHTML = html;

      console.log('metadata', converter.getMetadata());

      if (converter.getMetadata().title){
        document.title = converter.getMetadata().title;
      }

      Object.keys(converter.getMetadata()).map(
        (data) => {
          var meta = document.createElement('meta');
          meta.name = data;
          meta.content = converter.getMetadata()[data];
          document.getElementsByTagName('HEAD')[0].appendChild(meta);
        }
      );

      // remove the markdown source from the document
      document.getElementById("markdown-source").remove()
    });
    </script>
`;

const embeddedYoutubeLinks = `
<script>
  window.addEventListener('load', () => {
    
    let allLinks = document.getElementsByTagName("A");
    let properArray = [];
    for(let i=0;i<allLinks.length;i++){
      properArray.push(allLinks.item(i));
    }

    properArray.forEach(element => {
      const regExp = /^.*(youtu.be\\/|v\\/|u\\/\\w\\/|embed\\/|watch\\?v=|&v=)([^#&?]*).*/;
      const match = element.href.match(regExp);

      const videoId = (match && match[2].length === 11) ? match[2] : null;
      if(videoId === null) return; // not a youtube link

      const newElement = document.createElement('iframe');
      newElement.width = 560;
      newElement.height = 315;
      newElement.frameBorder = 0;
      newElement.allowFullscreen = true;
      newElement.src = 'https://www.youtube.com/embed/' + videoId + '?modestbranding=1'

      element.parentElement.replaceChild(newElement,element);
    });
  });
  </script>
`;

const addEditInVimLink = `
<script>
window.addEventListener('load', () => {
  const element = document.getElementById("markdown-url");
  const source_url = (element)?element.textContent:window.location.href;
  const description = "[edit in vIM]";
  const body = document.getElementById("markdown-body");
  const anchor = document.createElement('a');
  anchor.href = source_url;
  anchor.setAttribute("type","vim");
  anchor.style = 'position:fixed;right:20px;top:0';
  anchor.appendChild(document.createTextNode(description));
  
  body.appendChild(anchor);

  // remove the markdown url from the document
  document.getElementById("markdown-url").remove()
});
</script>
`;

const changeHtmlLinksToVim = `
<script>
  // changes all anchors marked with "vim" to vim links
  window.addEventListener('load', () => {
    let allLinks = document.getElementsByTagName("A");
    let properArray = [];
    for(let i=0;i<allLinks.length;i++){
      properArray.push(allLinks.item(i));
    }

    properArray.forEach(element => {
      if(element.type === "vim"){
        
        const textNode = document.createTextNode("\u00A0"); // &nbsp;
        const newElement = element.cloneNode(true);
        
        const parent = element.parentElement;
        element.parentElement.replaceChild(newElement, element);

        const href = element.href.replace("http://","vim://").replace("https://","vims://");
        newElement.href = href;
        newElement.setAttribute("class", "svg-icon-anchor");
        newElement.removeAttribute("type");
        delete newElement.type;

        const span = document.createElement('span');
        span.setAttribute("class", "svg-icon");

        newElement.appendChild(textNode);
        newElement.appendChild(span);
        newElement.setAttribute("title", "edit file in vIM");

        const newParentClassElements = (parent.getAttribute("class") || "") + " no-bottom-margin";
        parent.setAttribute("class", newParentClassElements.trim());
      }
    });
  });
</script>
`;

const baseCss = /* css */ `
  @media print {
    h1:not(:first-of-type) {
      break-before:always
    }
  }
  @media (max-width: 767px) {
    .markdown-body {
      padding: 15px;
    }
  }
  .markdown-body pre {
    padding: unset !important;
  }
  .markdown-body pre > svg {
    max-width: 100%;
    height: auto;
  }
  .markdown-body svg {
    max-width: 100%;
  }

  .markdown-body p.no-bottom-margin{
    margin-bottom: 0px !important;
  }

  a.svg-icon-anchor {
    display: flex;
    align-items: center;
  }

  .svg-icon {
    background: transparent url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3 NjAiIGhlaWdodD0iNzUwIiBmaWxsPSJub25lIiB4bWxuczp2PSJodHRwczovL3Zl Y3RhLmlvL25hbm8iPjxwYXRoIGQ9Ik02NiA2NmwxMi0yM2gyMzFsMTQ2IDUzIDIy LTUzIDI1Mi01IDE2IDUwLTEzMiAxNDB2Mjg5bDMwIDcgMTUtMjBoNDRsMTUgMjAt MzcgMTE5IDEzIDctNiAxNmgtNjVsMzAtMTEyaC00OGwtMzEgODkgOSA3djE2aC02 MWwyMC03My00NCA2LTIwIDY3LTE1OCA3LTc1LTYzLTUwIDQ4aC04M2wtMTAtNTMy LTM1LTI0VjY2eiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik03NjAgMzc0LjU2Mmgt Ljg1NUw2MjIuNDA4IDIzOS42MjUgNzU4LjY3IDEwMS42ODhWNDUuNjU2bC0yMC41 NTItMjAuMjVINDc4LjUxNWwtMjAuOSAxOC45MDZ2MzIuNjU2TDM4MC40NzUuODQ0 VjBMMzgwIC40MzggMzc5LjU1NyAwdi44NDRsLTQwLjg1IDQwLjM0NC0xNy4wMzct MTYuODQ0SDY0LjQ0Mkw0NC4yMzggNDUuOTY5djU4LjkwNmwxOS41MDcgMTkuMjVo MjIuOHYxNjUuOTM3TC44NTUgMzc0LjU5NEgwbC40NDMuNDA2LS40NDMuNDM4aC44 NTVMODYuNTQ1IDQ2MHYyMDIuMDk0bDI4LjcyMiAxNi4zNDRoNzMuNTNsNTguODA1 LTU5LjUgMTMxLjkyMyAxMzAuMTg3Vjc1MGwuNDc1LS40MzguNDQzLjQzOHYtLjg3 NWw3OS40ODQtNzguNDA2aDE1LjM1OGMzLjUxNSAwIDYuNjgyLTIuMTg4IDcuOTE3 LTUuNTk0bDQuNjIzLTEzLjMxM2E4LjExIDguMTEgMCAwIDAtMS4xNzItNy40Njhs NDYuMjk3LTQ1LjY4OC0xOS4zOCA2MS4zMTNjLTEuMzYyIDQuNDA2IDEuMTQgOS4w MzEgNS42MDUgMTAuMzc1YTguMzEgOC4zMSAwIDAgMCAyLjQ3LjM3NWg1Ny43NmMz LjM1Ny0uMDMxIDYuMzY1LTIgNy42OTUtNS4wOTRsNS4yMjUtMTIuMzEzYy43OTIt Mi4wMzEuNzYtNC4zMTItLjEyNy02LjM0My0uODU1LTIuMDMxLTIuNTMzLTMuNjI1 LTQuNjIzLTQuNDM4LS45MTgtLjM3NS0xLjk2My0uNTkzLTMuMDcyLS42MjVoLTIu Mzc1bDI2LjYtODIuNjI1aDM5LjAxNGwtMzIuMTc0IDEwMC42NTdjLTEuMzYxIDQu NDA2IDEuMTQgOS4wMzEgNS41NzQgMTAuMzc0Ljc5MS4yNSAxLjY0Ni4zNzYgMi41 MDEuMzc2aDYzLjM5N2MzLjQ4MyAwIDYuNTU1LTIuMDYzIDcuODUzLTUuMzEzTDcw MC4wODcgNjUyYzEuNjE1LTQuMzEyLS42NjUtOS4wNjItNS4wMDQtMTAuNjU2LS45 MTgtLjM0NC0xLjktLjUzMi0yLjg4MS0uNTMyaC00LjU5MmwzNS44MTUtMTE0Ljc4 MWMuODU1LTIuNTYyLjM4LTUuNDA2LTEuMjM1LTcuNWwtMTEuODc1LTE1Ljc1LS4w OTUtLjE1NmMtMS42MTUtMi00LjAyMi0zLjE4Ny02LjYxOC0zLjE4N2gtNDUuNDc0 YTguNDkgOC40OSAwIDAgMC02LjAxNiAyLjUzMWwtMTIuNjY3IDEzLjcxOWgtMTku NzZsLTEuMzMtMS40MzggMTQwLjc1OC0xMzguOTA2SDc2MGwtLjQ0My0uMzQ0LjQ0 My0uNDM4ek0zMTEuNTM3IDY2MC41OTRsNTAuMDAxLTE0MC45MDZoLTE1Ljg2NWw5 LjQwNS05LjVoNTIuNTM1bC00OS40OTUgMTQyLjM0M2gxOS43MjlsLTIuNTAyIDgu MDYzaC02My44MDh6bTExNy4wMDgtMjM0Ljg3NWw0Ljc1IDQuNzE5LTguNTE4IDI4 LjgxMi03LjEyNSA3LjA2MmgtMzAuNjg1bC01LjczMi01LjY1NiA5Ljg0OC0yNy4y MTggOS4xMi03LjcxOWgyOC4zNDJ6TTE3Ny4wMTcgNjUwLjkwNmgtNTQuMjQ1bC04 LjI5Ny00LjY4N1Y5Ni41OTRoLTM5LjE0bC0zLjE2Ny0zLjEyNXYtMzYuNzVsNC41 MjgtNC44MTNoMjMzLjQxNWw2Ljc0NSA2LjY4OHYzNC42MjVsLTQuNDk3IDUuNDA2 aC0zNC4xNjh2MjcxLjVsMjc4Ljg4OC0yNzEuNWgtNjYuMDU3bC01LjU0MS01Ljg3 NVY1Ni40MDZsMy44MzEtMy40NjloMjM3LjE4NGw0LjE4IDQuMTU2djMzLjQzN0w0 MTEuMDAyIDQxNC4wNjJIMzk5LjE5Yy0uNDc1LS4wMzEtLjg4NyAwLTEuMzMuMDMy bC0uNjMzLjA5NGMtMS40MjUuMzEyLTIuNzI0LjkzNy0zLjc2OSAxLjg3NGwtMTAu ODYxIDkuMjE5LS4xMjcuMDk0Yy0xLjA0NS45NjktMS44NjggMi4xNTYtMi4zMTIg My40NjlsLTkuMzczIDI1LjkzNy0xOTMuNzY4IDE5Ni4xMjV6bTQ2Ny42NTMtMTIz LjVsMTUuMDEtMTYuMjE4aDQyLjI0M2w5Ljc4NSAxMi45NjhMNjcxLjY1IDY1Mi41 aDE1LjYxMmwtMi41MzQgNi41MzFoLTU2LjQ2MWwzNS41OTMtMTExLjM3NWgtNjMu ODA4bC0zNC4xMDUgMTA1Ljk2OWgxMy40MjZsLTIuMzExIDUuNDM3aC01MC44MjVs MzUuMDU1LTExMC44NzRoLTY2LjM3NGwtMzMuNjMgMTA0LjM0M2gxMy44MDdsLTIu MjggNi41MzFoLTUyLjU5OGw0Ny45NDMtMTM5LjM3NGgtMTguNTU3bDIuODgyLTgu NDY5aDUyLjI1TDUyMS4xNyA1MjhoMjguNjlsMTUuNTQ4LTE3LjMxM2gzMy41OTls MTUuNDg1IDE2LjcxOWgzMC4xNzh6IiBmaWxsPSIjMTA3MTAwIi8+PC9zdmc+') no-repeat center center;
    background-size: cover;
    height: 20px;
    width: 20px;
  }

</style>
`;

const htmlTemplate = (markdown: string, url: string) =>
  `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <style>${baseCss}</style>
    ${showdownjsSupport}
    ${args.highlightSupport ? highlightSupport : ""}
    ${args.graphvizSupport ? graphvizSupport : ""}
    ${args.autotocSupport ? autotocSupport : ""}
    ${args.embeddedYoutubeLinks ? embeddedYoutubeLinks : ""}
    ${args.addEditInVimLink ? addEditInVimLink : ""}
    ${args.changeHtmlLinksToVim ? changeHtmlLinksToVim : ""}
    <title>untitled file</title>
</head>
<body>
<pre id="markdown-url" style="display:none">${url}</pre>
<pre id="markdown-source" style="display:none">${
    base64.encodeUnicode(markdown)
  }</pre>
<div id="markdown-body" class="markdown-body"></div>
</body>
</html>
`;

processPipeMessages<PipeServerAPIv03>(
  markdownToHtmlHandler,
  "markdown-to-html",
);

// vim: ts=2 sts=2 sw=2 tw=0 noet
